<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Board.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MCTS 2048</a> &gt; <a href="index.source.html" class="el_package">dk.ahle.thomas.mcts2048</a> &gt; <span class="el_source">Board.java</span></div><h1>Board.java</h1><pre class="source lang-java linenums">package dk.ahle.thomas.mcts2048;

import java.util.Arrays;
import java.util.Random;
import java.util.concurrent.ThreadLocalRandom;


<span class="fc" id="L8">public class Board {</span>
<span class="fc" id="L9">	public final static int orders[][] = {</span>
		{13, 14, 15, 16,  19, 20, 21, 22,  25, 26, 27, 28},
		{9, 15, 21, 27,  8, 14, 20, 26,  7, 13, 19, 25},
		{19, 20, 21, 22,  13, 14, 15, 16,  7, 8, 9, 10},
		{8, 14, 20, 26,  9, 15, 21, 27,  10, 16, 22, 28},
	};
<span class="fc" id="L15">	public final static int all[] = {7, 8, 9, 10,  13, 14, 15, 16,  19, 20, 21, 22,  25, 26, 27, 28};</span>
<span class="fc" id="L16">	public final static int dirs[] = {-6, 1, 6, -1};</span>
	
	public final static int UP = 0;
	public final static int RIGHT = 1;
	public final static int DOWN = 2;
	public final static int LEFT = 3;
<span class="fc" id="L22">	public final static int moves[] = {UP, RIGHT, DOWN, LEFT};</span>
	
<span class="fc" id="L24">	private int[] grid = new int[] {</span>
		-1, -1, -1, -1, -1, -1,
		-1,  0,  0,  0,  0, -1, 
		-1,  0,  0,  0,  0, -1, 
		-1,  0,  0,  0,  0, -1, 
		-1,  0,  0,  0,  0, -1, 
		-1, -1, -1, -1, -1, -1,
	};
<span class="fc" id="L32">	public boolean changed = false;</span>

<span class="fc" id="L34">	private Random rand = ThreadLocalRandom.current();</span>
	public void unsafe_spawn() {
		while (true) {
<span class="fc" id="L37">			int p = rand.nextInt(32);</span>
<span class="fc bfc" id="L38" title="All 2 branches covered.">			if (grid()[p] == 0) {</span>
<span class="fc" id="L39">				grid()[p] = pickRandomly();</span>
<span class="fc" id="L40">				break;</span>
			}
<span class="fc" id="L42">		}</span>
		// FIXME: Hangs if no spawn is available
<span class="fc" id="L44">	}</span>
	
	public int pickRandomly() {
<span class="fc bfc" id="L47" title="All 2 branches covered.">		return rand.nextInt(10) == 0 ? 2 : 1;</span>
	}
	
	public Board spawn() {
<span class="fc" id="L51">		Board board1 = copy();</span>
<span class="fc" id="L52">		board1.unsafe_spawn();</span>
<span class="fc" id="L53">		return board1;</span>
	}
	
<span class="fc" id="L56">	boolean merged[] = new boolean[36];</span>
	public void unsafe_move(int move) {
<span class="fc" id="L58">		Arrays.fill(merged, false);</span>
<span class="fc" id="L59">		changed = false;</span>
<span class="fc" id="L60">		int dir = dirs[move];</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">		for (int src : orders[move]) {</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">			if (grid[src] == 0)</span>
<span class="fc" id="L63">				continue;</span>
<span class="fc" id="L64">			int dst = src + dir;</span>
			// Move unto free squares
<span class="fc bfc" id="L66" title="All 2 branches covered.">			while (grid[dst] == 0) {</span>
<span class="fc" id="L67">				dst += dir;</span>
			}
			// Merge
<span class="fc bfc" id="L70" title="All 4 branches covered.">			if (grid[dst] == grid[src] &amp;&amp; !merged[dst]) {</span>
<span class="fc" id="L71">				grid[dst] += 1;</span>
<span class="fc" id="L72">				merged[dst] = true;</span>
<span class="fc" id="L73">				dst += dir;</span>
			}
			// Normal termination
			else {
<span class="fc" id="L77">				grid[dst - dir] = grid[src];</span>
			}
			// Move happened
<span class="fc bfc" id="L80" title="All 2 branches covered.">			if (dst != src + dir) {</span>
<span class="fc" id="L81">				grid[src] = 0;</span>
<span class="fc" id="L82">				changed = true;</span>
			}
		}
<span class="fc" id="L85">	}</span>
	
	public Board move(int move) {
<span class="fc" id="L88">		Board board = copy();</span>
<span class="fc" id="L89">		board.unsafe_move(move);</span>
<span class="fc" id="L90">		return board;</span>
	}
	
	public boolean isStuck() {
<span class="fc bfc" id="L94" title="All 2 branches covered.">		for (int p : all) {</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">			if (grid()[p] == 0)</span>
<span class="fc" id="L96">				return false;</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">			for (int dir : dirs) {</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">				if (grid()[p+dir] == grid()[p])</span>
<span class="fc" id="L99">					return false;</span>
			}
		}
<span class="fc" id="L102">		return true;</span>
	}
	
	public boolean isFull() {
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">		for (int p : all) {</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">			if (grid()[p] == 0)</span>
<span class="fc" id="L108">				return false;</span>
		}
<span class="nc" id="L110">		return true;</span>
	}
	
	public boolean canDirection(int move) {
<span class="fc" id="L114">		int dir = dirs[move];</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">		for (int p : orders[move]) {</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">			if (grid()[p+dir] == 0)</span>
<span class="fc" id="L117">				return true;</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">			if (grid()[p+dir] == grid()[p])</span>
<span class="fc" id="L119">				return true;</span>
		}
<span class="fc" id="L121">		return false;</span>
	}

	public void print() {
<span class="fc bfc" id="L125" title="All 2 branches covered.">		for (int i = 0; i &lt; 36; i++) {</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">			if (grid()[i] == 0)</span>
<span class="fc" id="L127">				System.out.print(&quot; .&quot;);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">			if (grid()[i] &gt; 0)</span>
<span class="fc" id="L129">				System.out.print(&quot; &quot; + grid()[i]);</span>
<span class="fc bfc" id="L130" title="All 6 branches covered.">			if (i % 6 == 0 &amp;&amp; i != 0 &amp;&amp; i != 6)</span>
<span class="fc" id="L131">				System.out.println();</span>
		}
<span class="fc" id="L133">		System.out.println();</span>
<span class="fc" id="L134">	}</span>
	
	public Board copy() {
<span class="fc" id="L137">		Board copy = new Board();</span>
<span class="fc" id="L138">		System.arraycopy(grid(), 0, copy.grid(), 0, 36);</span>
<span class="fc" id="L139">		return copy;</span>
	}

	@Override
	public int hashCode() {
<span class="fc" id="L144">		return Arrays.hashCode(grid());</span>
	}

	@Override
	public boolean equals(Object obj) {
<span class="fc bfc" id="L149" title="All 2 branches covered.">		if (this == obj)</span>
<span class="fc" id="L150">			return true;</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">		if (obj == null)</span>
<span class="fc" id="L152">			return false;</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">		if (!(obj instanceof Board))</span>
<span class="fc" id="L154">			return false;</span>
<span class="fc" id="L155">		Board other = (Board) obj;</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">		if (!Arrays.equals(grid(), other.grid()))</span>
<span class="fc" id="L157">			return false;</span>
<span class="fc" id="L158">		return true;</span>
	}

	@Override
	public String toString() {
<span class="fc" id="L163">		String s = &quot;&quot;;</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">		for (int p : all) {</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">			s += (char)(grid()[p]==0 ? '.' : grid()[p]+'0');</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">			if (p%6==4) s += &quot; &quot;;</span>
		}
<span class="fc" id="L168">		return &quot;Board [grid=&quot; + s + &quot;]&quot;;</span>
	}

	public int[] grid() {
<span class="fc" id="L172">		return grid;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>